---
title: "A2 - Análisis estadístico I"
author: "Fernando Antonio Barbeiro Campos - fbarbeiro@uoc.edu"

date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
#\usepackage{mathtools}
```
# Introducción

<div style="text-align: justify">
En esta actividad usaremos el fichero de **World Happiness Report** “limpio”, es decir, después del preproceso que se ha realizado. Una vez el fichero está preparado, pasaremos a realizar análisis propios de la estadística descriptiva e inferencial. Os proporcionamos el fichero **2016_clean.csv** para que todos trabajéis con el mismo fichero de datos, independientemente del resultado obtenido en la actividad 1.
Recordamos que el fichero de datos recoge información sobre el grado de felicidad de países del mundo. El archivo contiene 157 registros y 13 variables. Estas variables son: *Country, Region, HR, HS, LCI, UCI, GpC, Family, LE, Freedom, GC, Generosity, DR donde HR: Happiness Rank, HS: Happiness Score, LCI y UCI*:
*Lower y Upper Confidence Interval, GpC: GDP per Capita, LE: Life Expectancy, GC: Trust Government Corruption, DR: Dystopia.*
Recordar que **no** se pueden realizar listados completos de los datos en la solución. El motivo es que se generan ficheros de salida con centenares de páginas que son muy difícil de trazar y corregir. Para comprobar las funcionalidades del código, podéis usar **head** y **tail** que solo muestran unas líneas del fichero.
</div>

```{r chunck1}
# Loading the dataframe
df <- read.csv("2016_clean.csv")
head(df)
```

# 1. Estadística Descriptiva
<div style="text-align: justify">
*A continuación, se estudiarán algunos valores centrales y de dispersión de algunas variables del fichero. Realizar los pasos que se indican a continuación.*
</div>

## 1.1 Valores centrales de HS (*Happiness Score*)
<p style="text-align: justify">
Calcular la media, mediana y el sumario de cinco números (de Tukey) del valor HS Happiness Score de toda la muestra. A continuación, visualizar la distribución de este valor en un diagrama de caja (boxplot) e interpretar el resultado. Finalmente, visualizar otro diagrama de caja donde se muestre el valor de HS para cada región. Es decir, en el mismo gráfico debe haber una caja para cada región representada en el fichero. Interpretar los gráficos.
</p>
### Respuesta
```{r chunck2}
N <- length(df$HS)
# Media de Happiness Score
mean(df$HS) # Using function
sum(df$HS)/N # Manually calculating

#Mediana
median(df$HS)
HS_sorted <- sort(df$HS)

if((N %% 2) == 0) {
  print(paste("Mi mediana calculada es", (HS_sorted[floor((N+1)/2)] + HS_sorted[ceiling((N+1)/2)]) / 2))
} else {
  print(paste("Mi mediana calculada es", HS_sorted[(N+1)/2]))
}

# five numbers (Tukey)
fivenum(df$HS)
# five numbers + media
summary(fivenum(df$HS))

# One by one - manually
min(df$HS)
quantile(df$HS, 0.25) # Mediana del "bottom half"
median(df$HS)
quantile(df$HS, 0.75) # Mediana del "top half"
max(df$HS)

boxplot(df$HS)
```

<p style="text-align: justify">
La interpretación del gráfico de caja sobre la distribución de los valores de *Happiness Score* es bastante sencilla. En la parte más inferior del gráfico tenemos la línea del **valor mínimo** (2.905, según hemos extraído en  el sumario de cinco números). Entonces el dibujo de la caja en sí empieza en el **primer cuartil Q1** - 4.404 - que representa 25%, o sea, la mediana del *bottom half* de nuestra muestra. La próxima línea que tenemos trazada más en negrita es **la mediana - 5.314**, y en la parte superior de la caja, el **cuartil Q3 75%** - 6.269 -> mediana del *top half* de la muestra. Finalmente, la última línea superior arriba de la caja llega hasta al **valor máximo** de la muestra que es 7.526.
</p>

```{r chunck3}
summary(df$Region)

# Grafico para cada región representada
boxplot(df$HS ~ df$Region, main="Happiness Score by Region", ylab="Happiness Score", las=2)
```

##1.2 Cálculos sobre Generosity e identificación de outliers
<p style="text-align: justify">
Calcular la media, mediana y el sumario de cinco números (de Tukey) del valor Generosity de toda la muestra. Visualizar en un diagrama de caja (boxplot) e interpretar el resultado. ¿Existe algún outlier observable en HS o en Generosity? ¿Cómo afectan los outliers a los valores centrales calculados?
</p>

### Respuesta
```{r chunck4}
mean(df$Generosity) 
median(df$Generosity)
fivenum(df$Generosity)
summary(fivenum(df$Generosity))
boxplot(df$Generosity, main="Box plot Generosity")
```
<p style="text-align: justify">
Nuestro boxplot permite observar algunos valores outliers en *Generosity*: empezamos por la parte de abajo del gráfico: considerando que es un conjunto de datos que ha pasado por el preproceso (o sea, está limpio), las entradas de **valores mínimos** están en 0.0. El primer cuartil **Q1** empieza en 0.1546, con la línea **mediana** en negrita a 0.2225. Mientras tanto, el **Q3** representa un valor de 0.3119. Y por arriba de la línea max, **hay una serie de *outliers*** alrededor del valor 0.6 y llegando hasta el **máximo** de 0.8197.
</p>
<p style="text-align: justify">
Los *outliers* afectan especialmente a la media (**poco robusta**). Y cuando la muestra es pequeña, el efecto se nota aún más acentuado. Para representar que puede pasar, veamos un ejemplo:
</p>


```{r chunck5}
#¿Cómo afectan los outliers a los valores centrales calculados?
i1 <- c(1,1,1,2,1,1,2,1,1,2,1,3,3,2,3,2,2,4,1,1)
mean(i1)
median(i1)

i2 <- c(i1, 150)
mean(i2)
median(i2)
```

<p style="text-align: justify">
En **i1** se observa un conjunto bastante uniformemente distribuído, sin *outliers*, por lo tanto, la media y mediana están cerca una de la otra. Sin embargo, cuando añadimos un *outlier* en un nuevo conjunto **i2**, los valores han cambiado muchísimo para la media - ha subido hacia al valor más alto. Mientras tanto, mediana mantuvo un valor en el medio del listado. Este es un ejemplo de que acabamos de decir sobre la afectación de **medidas poco robustas**.
</p>

##1.3 Cálculos de dispersión
<p style="text-align: justify">
Calcular la dispersión del valor de Happiness Score usando las siguientes medidas: rango intercuartílico, varianza y desviación típica.
</p>

### Respuesta

```{r chunck6}
happiness <- df$HS
median(happiness)

ri <- quantile(happiness,.75) - quantile(happiness,.25)
print(paste("Rango Intercuartílico", ri))

#rango intercuartílico
IQR(happiness)

#varianza (suma del cuadrado de las desviaciones c respecto media / N)
var(happiness)

# Desviacion tipica - raiz varianza
sd(happiness) 
```


##1.4 Cálculos de dispersión manuales
<p style="text-align: justify">
Escribir una función denominada **my.mean** en R que calcule la media de un vector numérico. Escribir otra función denominada **my.var** que calcule la varianza de un vector numérico.
A continuación, llamar a la función **my.var** para obtener el valor de varianza de *HS* y de *Generosity*. Comprobar que el resultado sea el mismo que con la función correspondiente de R.
</p>
<p style="text-align: justify">
**Nota:** el objetivo de esta pregunta es, por una parte, aprender a crear funciones en R. Las funciones son útiles cuando un determinado cálculo se debe realizar varias veces. En este caso, las funciones que calculan medias y varianzas ya están definidas en R, pero realizamos de nuevo estas funciones como ejemplo ilustrativo. El segundo objetivo de esta pregunta es comprender cómo se realiza el cálculo de la media y la varianza.
</p>
### Respuesta
```{r chunck7}
my.mean <- function(x) {
  # media
  sum(x)/length(x)
}

my.var <- function(x) {
  # varianza muestral
  media_x <- my.mean(x)
  sum((x - media_x)^2) / (length(x) - 1)
}

my.validator <- function(x, y, operation, field) {
  if(x == y){
    print(paste("Well done, the ",operation," for ",field," is ", round(x,6)))
  } else {
    print(paste("Error - the function defined for ",operation, " returned values: ",x," != ",y))
  }
}

my.validator(my.mean(df$HS), mean(df$HS), "MEAN", "HS")
my.validator(my.var(df$HS), var(df$HS), "VAR", "HS")
my.validator(my.var(df$Generosity), var(df$Generosity), "VAR", "Generosity")
```
<hr />
# 2. Estadística Inferencial
<div style="text-align: justify">

## 2.1 Media de HS de todos los países
<p style="text-align: justify">
HS toma valores en una escala de 0 a 10, donde 10 es la máxima felicidad y 0 la mínima. ¿Podemos afirmar con un nivel de confianza del 99% que el valor medio de HS de todos los países del mundo es 5.0?
</p>
<p style="text-align: justify">
Para poder responder a esta pregunta, aplicaremos los métodos de contrastes de hipótesis. Para ello, seguir los pasos que se indican a continuación.
</p>
<p style="text-align: justify">
**Nota:** Para resolver esta pregunta y todas las siguientes del apartado de Estadística Inferencial, debéis hacer los cálculos manualmente, sin usar funciones de R que calculen el contraste directamente (del tipo t.test que se proporcionan desde R u otras similares que se puedan proporcionar en diferentes librerías). Podéis usar estas funciones de R sólo para comprobar vuestro resultado del cálculo manual.
</p>
<p style="text-align: justify">
Como sugerencia, si lo deseáis, podéis crear una función propia que realice los cálculos y esta función la podréis usar a lo largo de la actividad (en el caso de que sea reutilizable).
</p>


### 2.1.1 Escribir la hipótesis nula y alternativa

#### Respuesta
##### Hipótesis nula *H*<sub>0</sub>
<p style="text-align: justify">
Indica la hipótesis de partida, en este caso, la hipótesis de que los *HS* de todos los países del mundo es 5.0.
</p>

**H<sub>0</sub> : &mu; = 5.0 (HS)**

<br />

##### Hipótesis alternativa *H*<sub>1</sub>
<p style="text-align: justify">
Indica que se ha producido cambio con respecto a la situación propuesta inicialmente.
</p>

**H<sub>1</sub> : &mu; $\neq$ 5.0 (HS)**

### 2.1.1 Escribir qué tipo de contraste aplicaréis
<p style="text-align: justify">
El tipo de contraste utilizado será el contraste de hipótesis, o sea, comparar predicciones con la realidad que observamos y además, como tenemos *N* > 30, tendremos una funcción pivotal *Z* que será explicada más adelante en el codigo. Si dentro del margen de error que nos permitimos admitir (nivel de significación), hay coincidencia, aceptaremos la hipótesis y en caso contrario la rechazaremos.
</p>
<p style="text-align: justify">
Dentro del tema de contraste de hipótesis, tenemos que el nivel de significación &alpha; de un contraste es el error máximo de tipo I (rechazar *H<sub>0</sub>* cuando ésta es cierta) que estamos dispuestos a asumir, o sea, 1%, según el enunciado. Luego: &alpha; = 0,01. En mi punto de vista, tenemos un contraste conservador que tiende a aceptar la *hipótesis nula*.
</p>

### 2.1.3 Realizar los cálculos del contraste de hipótesis: calcular el estadístico de contraste observado y el valor crítico
<p style="text-align: justify">
Realizaremos primero el calculo del *estadístico de contraste* recordando que tal valor se usa para decidir si rechazamos la hipótesis nula o no.
</p>

```{r chunck8}
my.contrast <- function(x, mean_hipothesis){
  z <- (mean(x) - mean_hipothesis) / (sd(x) / sqrt(length(x)))
  print(paste("Contraste estadístico: ", z))
  z
}
mean_informed_h0 <- 5.0
z = my.contrast(df$HS, mean_informed_h0)

```
<p style="text-align: justify">
Para nuestro ejemplo, como hemos definido un contraste bilateral *(-z, z)*, tendrémos la conocida probabilidad de dos colas, donde, para definir **valor crítico**, tendrémos &alpha; = 0,01, luego:  *z<sub>&alpha;/2</sub>* = 2.576 y -2.576 (datos sacados de la tabla distribución normal).
</p>


### 2.1.4 Interpretar el resultado
<p style="text-align: justify">
Si nos fijamos que tenemos dos colas y estamos siguiendo las tablas de distribución normal respecto el *valor crítico* que hemos definido en el paso anterior, ahora es necesario ubicar el valor obtenido en el cálculo del estadístico de contraste (función Pivotal).
</p>
<p style="text-align: justify">
Para ello se puede usar una **curva de distribución**, donde tendrémos 2 zonas distintas: *Región de Rechazo o de Aceptación* (respectivamente vamos a llamar de RR y RA). RR sirvirá para los valores inferiores y superiores al valor crítico, esto es, z < -2.576 o z > 2.576. La región por el medio será la RA.
</p>
<p style="text-align: justify">
Como nuestro cálculo resulta en 4.19451 significa que estamos ubicados por arriba del Rechazo, con esto, deberíamos rechazamos la hipótesis nula *H<sub>0</sub>*.
</p>



